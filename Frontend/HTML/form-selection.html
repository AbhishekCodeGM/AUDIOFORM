<!-- form-selection.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Assistant - Select Form</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <main class="container">
        <h1>Select a Form</h1>
        <div class="form-options">
            <button class="form-option" data-form="basic-registration">
                Basic Registration Form
            </button>
            <button class="form-option" data-form="college-admission">
                College Admission Form
            </button>
            <button class="form-option" data-form="job-application">
                Job Application Form
            </button>
        </div>
        <button id="start-form" class="btn-primary" disabled>Start Form</button>
    </main>

    <!-- Listening Indicator -->
    <div id="listening-indicator" class="listening-indicator">
        <div class="listening-content">
            <div class="microphone-icon">ðŸŽ¤</div>
            <div class="listening-title">Listening...</div>
            <div class="listening-animation">
                <div class="listening-bar"></div>
                <div class="listening-bar"></div>
                <div class="listening-bar"></div>
                <div class="listening-bar"></div>
                <div class="listening-bar"></div>
            </div>
            <div class="listening-timer">
                <span id="timer-display">10</span>s
            </div>
            <div class="listening-text">Say your choice clearly</div>
        </div>
    </div>
    <script src="../js/state.js"></script>
    <script src="../js/voice.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/forms.js"></script>
    <script>
        let selectedForm = null;
        const accessibilityMode = State.getAccessibilityMode();
        const formOptions = [
            { key: 'basic-registration', name: 'Basic Registration Form' },
            { key: 'college-admission', name: 'College Admission Form' },
            { key: 'job-application', name: 'Job Application Form' }
        ];

        if (accessibilityMode === 'voice') {
            // Voice mode: Auto-navigate through forms
            initVoiceNavigation();
        } else {
            // Text mode: Manual selection
            initTextNavigation();
        }

        function initVoiceNavigation() {
            (async () => {
                // Ask for form selection with language support
                const language = State.getLanguage() || 'English';
                console.log('[Form Selection] Language from state:', language);
                
                // Ensure Voice has the correct language set
                Voice.setLanguage(language);
                console.log('[Form Selection] Voice language synchronized to:', language);
                
                let promptEN = 'Please select a form. Say one of the following: Basic Registration, College Admission, or Job Application.';
                let promptHI = 'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤• à¤«à¥‰à¤°à¥à¤® à¤šà¥à¤¨à¥‡à¤‚à¥¤ à¤¨à¤¿à¤®à¥à¤¨à¤²à¤¿à¤–à¤¿à¤¤ à¤®à¥‡à¤‚ à¤¸à¥‡ à¤à¤• à¤•à¤¹à¥‡à¤‚: à¤¬à¥‡à¤¸à¤¿à¤• à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£, à¤•à¥‰à¤²à¥‡à¤œ à¤ªà¥à¤°à¤µà¥‡à¤¶, à¤¯à¤¾ à¤¨à¥Œà¤•à¤°à¥€ à¤†à¤µà¥‡à¤¦à¤¨à¥¤';
                const prompt = language === 'Hindi' ? promptHI : promptEN;
                console.log('[Form Selection] Speaking prompt in:', language);
                
                await Voice.speak(prompt);
                
                // Wait for user to be ready to speak (pause after question announced)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Listen for answer after speech completes
                try {
                    const response = await Voice.listen();
                    console.log('[Form Selection] Raw response received:', response);
                    const lowerResponse = response.toLowerCase();
                    console.log('[Form Selection] Lowercase response:', lowerResponse);
                    
                    let selected = null;
                    
                    // Check for keywords - prioritize specific matches first to avoid conflicts
                    // Job Application should be checked first as it has more keywords
                    if (lowerResponse.includes('job') || response.includes('à¤¨à¥Œà¤•à¤°à¥€')) {
                        console.log('[Form Selection] Matched: Job Application');
                        selected = 'job-application';
                    } else if (lowerResponse.includes('college') || response.includes('à¤•à¥‰à¤²à¥‡à¤œ')) {
                        console.log('[Form Selection] Matched: College Admission');
                        selected = 'college-admission';
                    } else if (lowerResponse.includes('admission') || response.includes('à¤ªà¥à¤°à¤µà¥‡à¤¶')) {
                        console.log('[Form Selection] Matched: College Admission (via admission/à¤ªà¥à¤°à¤µà¥‡à¤¶)');
                        selected = 'college-admission';
                    } else if (lowerResponse.includes('basic') || response.includes('à¤¬à¥‡à¤¸à¤¿à¤•')) {
                        console.log('[Form Selection] Matched: Basic Registration');
                        selected = 'basic-registration';
                    } else if (lowerResponse.includes('registration') || response.includes('à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£')) {
                        console.log('[Form Selection] Matched: Basic Registration (via registration/à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£)');
                        selected = 'basic-registration';
                    } else if (lowerResponse.includes('application') || response.includes('à¤†à¤µà¥‡à¤¦à¤¨')) {
                        // Only match "application" if above didn't match (since job also has "application")
                        console.log('[Form Selection] Matched: Job Application (via application/à¤†à¤µà¥‡à¤¦à¤¨)');
                        selected = 'job-application';
                    }
                    
                    if (selected) {
                        console.log('[Form Selection] Selected form:', selected);
                        State.setSelectedForm(selected);
                        const selectedTitle = Forms.getTitle(selected);
                        const startingText = language === 'Hindi' 
                            ? `à¤¶à¥à¤°à¥‚ à¤•à¤° à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚ ${selectedTitle}`
                            : `Starting ${selectedTitle}`;
                        console.log('[Form Selection] Speaking start confirmation:', startingText);
                        await Voice.speak(startingText);
                        window.location.href = 'form-fill.html';
                    } else {
                        console.log('[Form Selection] No form matched for response:', response);
                        const errorText = language === 'Hindi' 
                            ? 'à¤®à¥à¤à¥‡ à¤¸à¤®à¤ à¤¨à¤¹à¥€à¤‚ à¤†à¤¯à¤¾à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤«à¤¿à¤° à¤¸à¥‡ à¤•à¥‹à¤¶à¤¿à¤¶ à¤•à¤°à¥‡à¤‚à¥¤'
                            : 'I did not understand. Please try again.';
                        await Voice.speak(errorText);
                        setTimeout(initVoiceNavigation, 1000);
                    }
                } catch (error) {
                    console.error('Voice error:', error);
                    const errorText = language === 'Hindi' 
                        ? 'à¤à¤• à¤¤à¥à¤°à¥à¤Ÿà¤¿ à¤¥à¥€à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤«à¤¿à¤° à¤¸à¥‡ à¤•à¥‹à¤¶à¤¿à¤¶ à¤•à¤°à¥‡à¤‚à¥¤'
                        : 'There was an error. Please try again.';
                    await Voice.speak(errorText);
                    setTimeout(initVoiceNavigation, 1000);
                }
            })();
        }

        function initTextNavigation() {
            document.querySelectorAll('.form-option').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.form-option').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedForm = this.dataset.form;
                    State.setSelectedForm(selectedForm);
                    document.getElementById('start-form').disabled = false;
                });
            });

            document.getElementById('start-form').addEventListener('click', function() {
                if (selectedForm) {
                    window.location.href = 'form-fill.html';
                }
            });
        }
    </script>
</body>
</html>